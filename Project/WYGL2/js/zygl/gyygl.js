Ext.namespace('Ext.Hudongsoft');

Ext.Hudongsoft.gyyglGrid=Ext.extend(Ext.grid.GridPanel ,{
    xtype:"grid",
	title:"工业园管理列表",
	store:new Ext.data.JsonStore({
		url: 'ajax/zygl/gyygl.aspx?action=list',
		fields:[
		    'id','序号','工业园名称','工业园面积'
		]
	}),
	width:778,
	height:544,
	columns:[
		{
			header:"编号",
			sortable:true,
			resizable:true,
			dataIndex:"序号",
			width:100
		},
		{
			header:"工业园名称",
			sortable:true,
			resizable:true,
			dataIndex:"工业园名称",
			width:100
		},
		{
			header:"工业面积（平方米）",
			sortable:true,
			resizable:true,
			dataIndex:"工业园面积",
			width:120
		}
	],
	listeners : {
	    celldblclick: function(grid, rowIndex, columnIndex, e) {
	        var r = grid.store.getAt(rowIndex);	
	        grid.showDetailWindow(false, r.data);
	    }
	},
	showDetailWindow: function (add, data) { // 显示详细窗体: add: 是否是新增数据, data: 数据参数
	    var self = this;
        var form = new Ext.FormPanel({	
            padding: 10,            
            items: [{
                xtype: 'hidden',
                name: 'id'
            },{
                fieldLabel: '序号',
                name: '序号',
                allowBlank:false,
                xtype: 'textfield'				                           
            },{
                fieldLabel: '工业园名称',
                name: '工业园名称',
                allowBlank:false,
                xtype: 'textfield'				                           
            },{
                fieldLabel: '工园业面积',
                name: '工业园面积',
                allowBlank:false,
                xtype: 'textfield'				                           
            }],
            buttons: [{
                text: '保存',
                iconCls: 'icon-save',
                handler: function (c) {                                
                    form.getForm().submit({
                        url: 'ajax/zygl/gyygl.aspx',
                        params: {
                            action: add?'add':'update'
                        },
                        success: function (form, action) {  
                            w.close();
                            self.store.reload();
                        }
                    });
                }
            },{
                text: '取消',
                iconCls: 'icon-cancel',
                handler: function (c) {
                    w.close();
                }
            }]
        });
        
        if (!add && data) {
            form.getForm().setValues(data);
        }
        
	    var w = new Ext.Window({
	        title: add?'新增工业园':'修改工业园',	
	        width: 300,			        
	        items:[
	            form
	        ]
	    });
	    w.show();
	},
	
	
	initComponent: function(){
	    var self = this;
	    this.bbar = new Ext.PagingToolbar({
	        pageSize: 20,
	        store: self.store,
	        displayInfo: true,
	        plugins: [new Ext.ux.ProgressBarPager()]
	    });
		this.tbar=[
			{
				text:"添加工业园",
				iconCls: 'icon-group-create',
				handler: function () {
                    self.showDetailWindow(true, null);
				}
			},
			{
				text:"修改工业园",
				iconCls: 'icon-group-update',
				handler: function() {
				    var r = self.getSelectionModel().getSelected();
				    if (r) {
				        self.showDetailWindow(false, r.data);
				    }				    
				}
			},
			{
				text:"删除工业园",
				iconCls: 'icon-group-delete',
				handler: function () {
				    var r = self.getSelectionModel().getSelected();
				    if (r) {
				        Ext.Msg.confirm('删除工业园','确定要删除选中工业园吗？',function(btn){
							if(btn == 'yes') {
								Ext.Ajax.request({
									url:'ajax/zygl/gyygl.aspx?action=delete',
									success:function(){
										Ext.Msg.alert('删除工业园','工业园删除成功！');
										self.store.reload();
									},
									params:{id: r.get('id')}
								});
							}
						});
				    }				    
				}
			},
			{
				text:"编辑房产类型",
				iconCls: 'icon-xieGenJin',
				handler:function () {
				    var r = self.getSelectionModel().getSelected();
				    if (!r) return;
				    var lxstore = new Ext.data.JsonStore({
                        url: 'ajax/zygl/gyygl.aspx?action=lx_list&find_id='+escape(r.data.工业园名称),
                        fields:[
                            'id','序号','工业园名称','房产类型'
                        ]
	                }); 
	                
	                var lxgird = new Ext.grid.GridPanel({
	                    store:lxstore,
	                    layout:'fit',
	                    columns:[
	                                {
			                            header:"编号",
			                            sortable:true,
			                            resizable:true,
			                            dataIndex:"序号",
			                            width:200
			                           
		                            },
		                            {
			                            header:"房产类型",
			                            sortable:true,
			                            resizable:true,
			                            dataIndex:"房产类型",
			                            width:300
			                            
		                            }
	                            ]
	                            ,
	                            listeners : {
	                                celldblclick: function(grid, rowIndex, columnIndex, e) {
	                                    var d = grid.store.getAt(rowIndex);	
	                                    showLx(false, d.data);
	                                }
	                            }
	                });
	                
	                function showLx(add,data) {
	                    var lxform = new Ext.FormPanel({
	                        padding:10,
	                        items:[
	                            {
	                                xtype: 'hidden',
                                    name: 'id',
                                    value: r.json.id 
	                            },
                                {
                                    xtype: 'hidden',
                                    name: '工业园名称',
                                    value: r.json.工业园名称    
                                },
                                {
                                    fieldLabel:'编号',
                                    name:'序号',
                                    allowBlank:false,
                                    xtype: 'textfield' 
                                },
                                {
                                    fieldLabel:'房产类型',
                                    name:'房产类型',
                                    allowBlank:false,
                                    xtype: 'textfield' 
                                }
                                
                            ],
                            buttons:[
                                {
                                    text: '保存',
                                    iconCls: 'icon-save',
                                    handler:function () {
                                        lxform.getForm().submit({
                                            url: 'ajax/zygl/gyygl.aspx',
                                            params: {
                                                action:add? 'addlx':'updatelx'
                                            },
                                            success: function (form, action) {  
                                                //console.log(action.response.responseText);                                      
                                                lxWin.close();
                                                lxstore.reload();
                                            }
                                        });
                                    } 
                                },
                                {
                                    text: '取消',
                                    iconCls: 'icon-cancel',
                                    handler: function () {
                                        lxWin.close();
                                    }
                                }
                            ]
	                    });
	                    
                        var lxWin = new Ext.Window({
                            title:add?'新增类型':'修改类型',
                            width:300,
                            height:150,
                            layout:'fit',
                            items:[                                     
                                   lxform 
                            ]
                        });
                        
                    if (!add && data) {
                        lxform.getForm().setValues(data);
                    }
                    
                    lxWin.show();
	                }        
	                       
				    var win = new Ext.Window({
				        title:"房产类型列表",
				        width:600,
				        height:400,
				        layout:'fit',
				        tbar:[
				            {
				                text:"新增类型",
				                iconCls: 'icon-group-create',
				                handler:function(){
				                    showLx(true,null);
                                }
				            },
				            {
				                text:"修改类型",
				                iconCls: 'icon-group-update',
				                handler:function () {
				                    var d = lxgird.getSelectionModel().getSelected();
                                    showLx(false,d.data); 
				                    
				                }
				            },
				            {
				                text:"删除类型",
				                iconCls: 'icon-group-delete',
				                handler: function () {
				                    var d = lxgird.getSelectionModel().getSelected();
				                    if (d) {
				                        Ext.Msg.confirm('删除房产类型','确定要删除选中的房产类型吗？',function(btn){
							                if(btn == 'yes') {
								                Ext.Ajax.request({
									                url:'ajax/zygl/gyygl.aspx?action=deletelx',
									                success:function(){
										                Ext.Msg.alert('删除房产类型','房产类型删除成功！');
										                lxstore.reload();
									                },
									                params:{id: d.get('id')}
								                });
							                }
						                });
				                    }				    
				                }
				            },
				            {
				                text:"编辑房产消费列表",
				                iconCls: 'icon-xieGenJin',
				                handler:function () {
				                    var d = lxgird.getSelectionModel().getSelected();
				                    var fcxfStore = new Ext.data.JsonStore({
				                        url: 'ajax/zygl/gyygl.aspx?action=fcxf_list',
		                                fields:[
		                                    'id','序号','工业园名称','房产类型','消费项目','消费类型','值','倍率','损耗','滞纳金','说明'
		                                ],
		                                baseParams:{
		                                    gyyName:d.data.工业园名称,
		                                    fclx:d.data.房产类型
		                                }
				                    });
				                    //console.log(d);
				                    
				                    
				                    var fcxfGird = new Ext.grid.GridPanel({
	                                    store:fcxfStore,
	                                    columns:[
                                            {
	                                            header:"编号",
	                                            sortable:true,
	                                            resizable:true,
	                                            dataIndex:"序号",
	                                            width:50
        			                           
                                            },
                                            {
	                                            header:"消费项目",
	                                            sortable:true,
	                                            resizable:true,
	                                            dataIndex:"消费项目",
	                                            width:100
        			                            
                                            },
                                            {
                                                header:"消费类型",
	                                            sortable:true,
	                                            resizable:true,
	                                            dataIndex:"消费类型",
	                                            width:100
                                            },
                                            {
                                                header:"值",
	                                            sortable:true,
	                                            resizable:true,
	                                            dataIndex:"值",
	                                            width:100
                                            },
                                            {
                                                header:"倍率",
	                                            sortable:true,
	                                            resizable:true,
	                                            dataIndex:"倍率",
	                                            width:100
                                            },
                                            {
                                                header:"损耗",
	                                            sortable:true,
	                                            resizable:true,
	                                            dataIndex:"损耗",
	                                            width:100
                                            },
                                            {
                                                header:"滞纳金",
	                                            sortable:true,
	                                            resizable:true,
	                                            dataIndex:"滞纳金",
	                                            width:100
                                            },
                                            {
                                                header:"说明",
	                                            dataIndex:"说明",
	                                            width:100
                                            }
                                        ]
	                                });
	                                
	                                var fcxfWin = new Ext.Window({
	                                    layout:'fit',
	                                    width:800,
	                                    height:400,
	                                    tbar:[
	                                        {
	                                            text:"新增房产消费",
	                                            iconCls: 'icon-group-create',
	                                            handler:function(){
                                                     addxfx(d,fcxfStore,null);
    
                                                }
	                                        },
	                                        {
	                                            text:"删除房产消费",
	                                            iconCls: 'icon-group-update',
	                                            handler:function () {
	                                                var d = fcxfGird.getSelectionModel().getSelected();
                                                    if (d) {
				                                        Ext.Msg.confirm('删除房产消费','确定要删除选中的房产消费吗？',function(btn){
							                                if(btn == 'yes') {
								                                Ext.Ajax.request({
									                                url:'ajax/zygl/gyygl.aspx?action=delete_fcxf',
									                                success:function(){
										                                Ext.Msg.alert('删除房产消费','房产消费删除成功！');
										                                fcxfStore.reload();
									                                },
									                                params:{id: d.get('id')}
								                                });
							                                }
						                                });
				                                    } 
	                                            }
	                                        }
	                                    ],
				                        items:[
				                            fcxfGird
				                        ]
				                    });
				                    fcxfWin.show();
				                    fcxfStore.load();
				                }
				            }
				        ],
				        items:[
				            lxgird
				        ]
				        
				    });
				    win.show();
				    lxstore.load();
				    
				
				}
			}
		];
		self.store.load();
		Ext.Hudongsoft.gyyglGrid.superclass.initComponent.call(this);
	}
});